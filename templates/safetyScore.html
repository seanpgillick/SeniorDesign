{% block content %}
<div class="mt-2">
    <div id="#google_maps_div"></div>
    {% set inputValue = "" %}
    {% set inputRadius = "" %}
    {% if(address) %}
        {% set inputValue = address %}
    {% endif %}
    {% if(radius) %}
        {% set inputRadius = radius %}
    {% endif %}

    {% if(unit =="mi") %}
        {% set milesSelected = "selected" %}
        {% set kmSelected = "" %}
    {% else %}
        {% set milesSelected = "" %}
        {% set kmSelected = "selected" %}
    {% endif %}
        <div class="text-center mb-2">
            <i class="text-muted">Enter an address and radius to check the safety score of a specific area of {{ city }}</i>
        </div>
        <div class="row g-2 w-50 mx-auto">
            <div class="col-sm-5"> 
                <input
                placeholder="Address"
                list="addresses"
                id="address-input"
                type="text"
                class="form-control"
                value="{{ inputValue }}"/>
            </div>

            <div class="col-sm-3">
                <input
                placeholder="Radius"
                id="radius-input"
                type="number"
                min="1"
                class="form-control"
                value="{{ inputRadius }}"/>
            </div>
            <div class="col-sm-2">
                <select class="form-select" id="radius_unit" style="background-color: #E9ECEF;">
                    <option {{ milesSelected }} value="mi">mi</option>
                    <option {{ kmSelected }} value="km">km</option>
                </select>
            </div>
            <div class="col-sm-2">
                <button type="button" id="calculate-score" class="btn btn-outline-primary">Calculate</button>
            </div>
        </div>   
    <div class="text-center">
        <p id="calculating-score"></p>
    </div>
    {% if(safetyScore) %}
        {% if safetyScore == 1 %}
            {% set cardColor = "danger" %}
            {% set cardText = "A safety score of 1 means this area is very unsafe compared to the rest of Philadelphia." %}
        {% elif safetyScore == 2 %}
            {% set cardColor = "danger" %}
            {% set cardText = "A safety score of 2 means this area is unsafe compared to the rest of Philadelphia." %}
        {% elif safetyScore == 3 %}
            {% set cardColor = "warning" %}
            {% set cardText = "A safety score of 3 means this area is okay compared to the rest of Philadelphia." %}
        {% elif safetyScore == 4 %}
            {% set cardColor = "success" %}
            {% set cardText = "A safety score of 4 means this area is safe compared to the rest of Philadelphia." %}
        {% else %}
            {% set cardColor = "success" %}
            {% set cardText = "A safety score of 5 means this area is very safe compared to the rest of Philadelphia." %}
        {% endif %}
        <div>
            <div class="card w-25 mx-auto border-{{ cardColor }}">
                <h5 class="card-header text-center ">Safety Score</h5>
                <div class="card-body">
                <h5 class="card-title text-center text-{{ cardColor }}">{{ safetyScore }}</h5>
                <p class="card-text text-{{ cardColor }}">{{ cardText }}</p>
                </div>
            </div>
        </div>
    {% endif %}
</div>
<script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwhEnLg4K-Bhhuntc3zoMw7oVIhI0neqk&libraries=places&callback=initMap">
</script>
<script>
    function initMap(){}

    $( document ).ready(function() {
        const autocomplete = new google.maps.places.Autocomplete($("#address-input").get(0));

        autocomplete.setFields(["formatted_address", "geometry"]);
                
        autocomplete.addListener('place_changed', function (place) {
            $("#calculate-score").data("lng",  autocomplete.getPlace().geometry.location.lng());
            $("#calculate-score").data("lat", autocomplete.getPlace().geometry.location.lat()); 
            $("#calculate-score").data("address", autocomplete.getPlace().formatted_address);
        });

       $("#calculate-score").on("click", function (){
            let selectedAddress = $(this).data("address");            
            let radius = $("#radius-input").val();

            if(!selectedAddress){
                $("#address-input").addClass("is-invalid");
            }
            if(!radius){
                $("#radius-input").addClass("is-invalid");
            }

            if(selectedAddress && radius){
                $("#calculating-score").text("Calculating safety score...");
                let latitude = $(this).data("lat");
                let longitude = $(this).data("lng");
                let unit = $("#radius_unit").find(":selected").val();

                window.location.href = "/analysis/Philadelphia/safety?address="+selectedAddress+"&latitude="+latitude+"&longitude="+longitude+"&radius="+radius+"&city={{ city }}&unit="+unit;
            }
            
       });
    });
</script>
{% endblock %}
